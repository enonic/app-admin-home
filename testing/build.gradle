import com.enonic.uitest.server.ServerInstance

plugins {
    id 'java'
    id 'maven-publish'
    id 'com.enonic.defaults'
    id 'com.enonic.xp.base'
    id 'com.github.node-gradle.node'
}
group = 'com.enonic.xp.js_testing'

repositories {
    mavenCentral()
    xp.enonicRepo('dev')
}

configurations {
    distro
}

enonic {
    publishRepo = 'inhouse'
}

ext {
    unpackDir = "$buildDir/install"
    screenshotsDir = "$buildDir/screenshots"
    distroDir = "$unpackDir/enonic-xp-generic-$version"
    deployDir = "$distroDir/home/deploy"
    seleniumDir = "$projectDir/test-data/selenium"
    mochaResultsDir = "$projectDir/mochawesome-report"
    testDataDir = "$projectDir/test-data/common-config"
    xpHome = "$distroDir/home"
    configDir = "$xpHome/config"
    xpServer = new ServerInstance()
}

dependencies {
    distro "com.enonic.xp:enonic-xp-generic:$version@zip"
}

task unpackDistro( type: Copy ) {
    from {
        configurations.distro.collect { zipTree( it ) }
    }
    into file( unpackDir )
}

task ensureScreenshotsDirectory {
    doLast {
        mkdir screenshotsDir
    }
}

task copyConfig( type: Copy ) {
    println testDataDir
    from testDataDir
    include '**.*.cfg'
    include '*.properties'
    into file( configDir )
    mustRunAfter unpackDistro
}

task zipScreenshots( type: Zip ) {
    from screenshotsDir
    include '*'
    include '*/*'
    classifier 'screenshots'
}

task zipReport( type: Zip ) {
    from mochaResultsDir
    include '*'
    include '*/*'
    classifier 'mochaReport'
}

publishing {
    publications {
        mavenJava( MavenPublication ) {
            artifact zipScreenshots
            artifact zipReport
        }
    }
}

task startServer( dependsOn: [unpackDistro, copyConfig] ) {
    doLast {
        xpServer.installDir = file( distroDir )
        xpServer.start()
    }
    mustRunAfter npmInstall
}

task stopServer {
    doLast {
        xpServer.stop()
    }
}

task testAdminHomeApp( type: NpmTask, dependsOn: [npmInstall, startServer, ensureScreenshotsDirectory] ) {
    args = ['test']
}

task testAdminHomeAppLocally( type: NpmTask, dependsOn: [npmInstall, ensureScreenshotsDirectory] ) {
    args = ['test']
}

